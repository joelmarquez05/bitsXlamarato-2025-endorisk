# Instruccions per a l'Agent d'IA - Projecte NEST

## Resum del Projecte
**Nom:** NEST (NSMP Endometrial Stratification Tool)
**Objectiu:** Predir la **probabilitat de recaiguda** en pacients amb C√†ncer d'Endometri NSMP.
**Usuaris finals:** Onc√≤legs Ginecol√≤gics.

## Producte Final
Aplicaci√≥ Streamlit amb:
1. **Login** - Autenticaci√≥ del doctor
2. **Formulari** - Entrada de dades del pacient
3. **Resultat** amb 3 panells:
   - Predicci√≥ (probabilitat + sem√†for üü¢üü°üî¥)
   - Interpretabilitat (gr√†fic d'import√†ncia de features, t√®cniques com SHAP)
   - Explicaci√≥ IA (Gemini API)
4. **Disseny Responsive** - L'app ha de visualitzar-se correctament en dispositius m√≤bils (ytel√®fons)

## Coneixement M√®dic Cr√≠tic
- **NSMP** = 50% dels casos, grup "calaix de sastre"
- **Prioritzem Sensibilitat (Recall)** - Un Fals Negatiu √©s fatal
- Divisi√≥ en: Baix, Mitj√† i Alt Risc

## Stack T√®cnic
- Python 3.11 / Streamlit / Scikit-learn / Pandas / Joblib
- Google Gemini API (explicacions)
- Docker & Docker Compose

## Estructura de Fitxers
```
‚îú‚îÄ‚îÄ data/raw/           # Dades originals
‚îú‚îÄ‚îÄ data/processed/     # Dades netes
‚îú‚îÄ‚îÄ notebooks/          # 01‚Üí02‚Üí03‚Üí04 en ordre
‚îú‚îÄ‚îÄ models/             # Models entrenats (.joblib)
‚îî‚îÄ‚îÄ app/                # Streamlit app
```

---

## Regles Obligat√≤ries per a l'IA

### 1. Notebooks (.ipynb)
**MAI editis un fitxer `.ipynb` directament.**
Nom√©s proporciona el codi perqu√® l'usuari el copi√Ø.

### 2. Comentaris
- **Minimitza els comentaris** - Nom√©s quan sigui estrictament necessari
- **Tots els comentaris en CATAL√Ä**
- Exemple:
```python
# Carreguem el model entrenat
model = joblib.load('models/model.joblib')

# Fem la predicci√≥
prob = model.predict_proba(X)[0][1]
```

### 3. Idioma del Codi
| Element | Idioma |
|---------|--------|
| Variables i funcions | Angl√®s |
| Comentaris | Catal√† |
| UI Strings | Castell√†/Catal√† |

### 4. Convencions de Naming

#### Variables
```python
# ‚úÖ Correcte: snake_case, descriptiu, angl√®s
patient_age = 65
tumor_grade = 3
myometrial_invasion = 0.6
has_lvsi = True
recurrence_probability = 0.78

# ‚ùå Incorrecte
edad = 65           # Castell√†
tg = 3              # Massa curt
myometrialInvasion  # camelCase
```

#### Funcions
```python
# ‚úÖ Correcte: snake_case, verb + noun
def load_patient_data(filepath):
    pass

def calculate_recurrence_risk(features):
    pass

def preprocess_clinical_features(df):
    pass

# ‚ùå Incorrecte
def calcularRiesgo():    # Castell√† + camelCase
def data():              # Massa gen√®ric
def process():           # Qu√® processa?
```

#### Classes
```python
# ‚úÖ Correcte: PascalCase
class PatientData:
    pass

class RecurrencePredictor:
    pass

class FeatureEncoder:
    pass
```

#### Constants
```python
# ‚úÖ Correcte: SCREAMING_SNAKE_CASE
TARGET_COLUMN = 'recurrence'
RISK_THRESHOLDS = {'low': 0.3, 'medium': 0.6, 'high': 0.8}
MODEL_PATH = 'models/model.joblib'
GEMINI_MODEL = 'gemini-pro'
```

#### Fitxers
| Tipus | Format | Exemple |
|-------|--------|---------|
| Notebooks | `##_descriptive_name.ipynb` | `03_model_training.ipynb` |
| M√≤duls Python | `snake_case.py` | `feature_engineering.py` |
| Models | `model_name.joblib` | `random_forest_v2.joblib` |
| Dades | `descriptive_name.csv` | `features_train.csv` |

#### Prefixos i Sufixos Est√†ndard
| Prefix/Sufix | Significat | Exemple |
|--------------|------------|---------|
| `X_`, `y_` | Features / Target | `X_train`, `y_test` |
| `_df` | DataFrame | `patients_df` |
| `_path` | Ruta de fitxer | `model_path` |
| `_config` | Configuraci√≥ | `app_config` |
| `is_`, `has_` | Booleans | `is_valid`, `has_lvsi` |
| `n_`, `num_` | Comptadors | `n_samples`, `num_features` |
| `_scaled` | Dades normalitzades | `X_scaled` |
| `_encoded` | Dades codificades | `stage_encoded` |

#### Convencions de Versionat

Quan es fan m√∫ltiples experiments (preprocessats, models, etc.), segueix aquest format:

**Format:** `nom_descriptiu_vX.extensi√≥`

| Tipus | Exemple | Descripci√≥ |
|-------|---------|------------|
| **Models** | `random_forest_v1.joblib` | Versi√≥ 1 del RF |
|  | `xgboost_smote_v2.joblib` | XGBoost amb SMOTE, versi√≥ 2 |
| **Scalers** | `scaler_v1.joblib` | Scaler per a v1 del model |
|  | `scaler_minmax_v2.joblib` | MinMaxScaler per a v2 |
| **Dades processades** | `features_train_v1.csv` | Train set versi√≥ 1 |
|  | `features_train_smote_v2.csv` | Amb SMOTE aplicat |
| **Encoders** | `label_encoder_v1.joblib` | Encoder per a categoricals |

**Regles:**
- Sempre incrementa la versi√≥ quan canvi√Øs el preprocessat o els hiperpar√†metres
- Inclou t√®cnica en el nom si √©s rellevant (`_smote`, `_minmax`, `_pca`)
- El model i el scaler han de coincidir en versi√≥ (`model_v2` + `scaler_v2`)
- MAI sobreescriguis versions anteriors, crea una nova

**Estructura de directoris recomanada:**
```
models/
‚îú‚îÄ‚îÄ model_v1.joblib           # Baseline
‚îú‚îÄ‚îÄ model_v2.joblib           # Amb tuning
‚îú‚îÄ‚îÄ model_smote_v3.joblib     # Amb SMOTE
‚îú‚îÄ‚îÄ scaler_v1.joblib
‚îú‚îÄ‚îÄ scaler_v2.joblib
‚îî‚îÄ‚îÄ scaler_v3.joblib

data/processed/
‚îú‚îÄ‚îÄ features_train_v1.csv
‚îú‚îÄ‚îÄ features_test_v1.csv
‚îú‚îÄ‚îÄ features_train_v2.csv     # Nou preprocessat
‚îî‚îÄ‚îÄ features_test_v2.csv
```

### 5. Estil de Codi
- Segueix PEP 8
- Codi net i llegible
- M√†xim 88 car√†cters per l√≠nia
- Evita codi redundant

### 6. Convencions de Fitxers

#### Imports (ordre)
```python
# 1. Standard library
import os
from pathlib import Path

# 2. Third-party
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestClassifier
```

#### Estructura d'un m√≤dul
```python
"""
Descripci√≥ breu del m√≤dul (en angl√®s).
"""
# Imports
import pandas as pd

# Constants
TARGET_COLUMN = 'recurrence'

# Funcions auxiliars (privades amb _)
def _validate_input(df):
    pass

# Funcions p√∫bliques
def load_data(path):
    pass

# Classes
class DataProcessor:
    pass
```

### 7. Vocabulari del Domini (Terminologia M√®dica)

Utilitza sempre aquests termes en angl√®s per consist√®ncia:

| Catal√†/Castell√† | Angl√®s (usar sempre) |
|-----------------|---------------------|
| Recaiguda/Reca√≠da | `recurrence` |
| Grau tumoral | `tumor_grade` |
| Invasi√≥ miometrial | `myometrial_invasion` |
| Estadi | `stage` |
| LVSI | `lvsi` (ja √©s acr√≤nim angl√®s) |
| Pacient | `patient` |
| Predicci√≥ | `prediction` |
| Probabilitat | `probability` |
| Risc | `risk` |
| Alt/Mitj√†/Baix | `high`, `medium`, `low` |

---

## Informaci√≥ T√®cnica del Projecte

### Workflow de Notebooks (Executar en ORDRE)

```
01_exploratory_analysis.ipynb  ‚Üí No guarda res
02_data_preprocessing.ipynb    ‚Üí GUARDA: data/processed/*.csv, models/scaler.joblib
03_model_training.ipynb        ‚Üí CARGA des de data/processed/, GUARDA: models/model.joblib
04_model_evaluation.ipynb      ‚Üí CARGA: models/model.joblib, features_test.csv
app/main.py (Streamlit)        ‚Üí CARGA: models/model.joblib, models/scaler.joblib
```

### Joblib (Persist√®ncia de Models)

Guardar model/scaler:
```python
import joblib
joblib.dump(model, '../models/model.joblib')
joblib.dump(scaler, '../models/scaler.joblib')
```

Carregar en app o notebook posterior:
```python
model = joblib.load('models/model.joblib')
scaler = joblib.load('models/scaler.joblib')
```

### Entorns d'Execuci√≥

| Entorn | √ös | Comanda |
|--------|-----|---------|
| **Docker** | App Streamlit | `docker compose up --build -d` |
| **venv local** | Notebooks | `.venv\Scripts\activate` |

### Paths Importants (des de notebooks/)
- Dades: `../data/processed/`
- Models: `../models/`
- Scaler: `../models/scaler.joblib`

### Paths Importants (des de app/)
- Models: `models/` (sense `../` perqu√® Docker munta a /app)

---

# Context del Projecte: Predicci√≥ de Recaiguda en C√†ncer d'Endometri (Perfil NSMP)

**Objectiu:** Entrenar un model de Machine Learning (Classificaci√≥ Bin√†ria) per predir la variable `recidiva`.
**Dataset:** `data/raw/cancer_endometri.csv` - Dades cl√≠niques, patol√≤giques i moleculars de pacients amb c√†ncer d'endometri.
**Focus:** Especial inter√®s en el perfil molecular **NSMP** (Non-Specific Molecular Profile), on els receptors hormonals s√≥n clau.

---

## 1. Variable Objectiu (Target) üéØ

*   **`recidiva`**:
    *   **0**: No (Pacient lliure de malaltia).
    *   **1**: S√≠ (La malaltia va reapar√®ixer).
    *   **Acci√≥:** Aquesta √©s l'etiqueta a predir (`y`).
    *   *Nota:* Eliminar files on el valor sigui `2` (Desconegut) o `NA`.

---

## 2. Variables Predictores (Features) ‚úÖ

Aquestes s√≥n les columnes que contenen informaci√≥ v√†lida (cl√≠nica, patol√≤gica o molecular) disponible despr√©s de la cirurgia inicial i que has d'usar per entrenar el model (`X`).

### A. Perfil Pacient
*   **`edad`**: Num√®rica. Edat al diagn√≤stic.
*   **`imc`**: Num√®rica. √çndex de Massa Corporal (Obesitat √©s factor de risc).
*   **`asa`**: Categ√≤rica/Ordinal (1-4). Estat f√≠sic de la pacient (comorbiditats).

### B. Caracter√≠stiques del Tumor (Patologia)
*   **`histo_defin`** (o `tipo_histologico`): Categ√≤rica. Tipus de c√†ncer (Endometrioide, Ser√≥s, etc.). *Crucial*.
*   **`grado_histologi`** (o `Grado`): Categ√≤rica/Ordinal.
    *   `1`: Baix grau (G1-G2).
    *   `2`: Alt grau (G3). *Factor de risc alt*.
*   **`tamano_tumoral`**: Num√®rica. Mida en cm.
*   **`infiltracion_mi`**: Categ√≤rica/Ordinal. Profunditat d'invasi√≥ en l'√∫ter.
    *   `0`: No, `1`: <50%, `2`: >50%, `3`: Serosa. *A major valor, major risc*.
*   **`afectacion_linf`** (LVSI): Bin√†ria (0/1). Invasi√≥ Limfovascular. *Factor pron√≤stic cr√≠tic*.
*   **`infilt_estr_cervix`**: Bin√†ria (0/1). Si el tumor ha baixat al coll uter√≠.
*   **`FIGO2023`**: Categ√≤rica (Estadiatge). Resumeix la gravetat.
    *   **Transformaci√≥:** Convertir a escala ordinal (IA1=1, IA2=2 ... IVC=14).

### C. Perfil Molecular (Clau per a NSMP) üß¨
*   **`recep_est_porcent`**: Num√®rica (0-100). **Variable Estrella**. Percentatge de Receptors d'Estrogen.
    *   *Hip√≤tesi:* En NSMP, alt percentatge = millor pron√≤stic.
*   **`rece_de_Ppor`**: Num√®rica (0-100). Receptors de Progesterona.
*   **`p53_ihq`**: Categ√≤rica. (1=Normal, 2=Anormal/Mutat). *Defineix subtipus*.
*   **`mut_pole`**: Categ√≤rica. (1=Mutat, 2=No mutat). *Defineix subtipus*.
*   **`msh2`, `msh6`, `pms2`, `mlh1`**: Categ√≤riques. Prote√Ønes de reparaci√≥ (Mismatch Repair). Si alguna √©s anormal (1), √©s perfil MMRd.

### D. Dades Quir√∫rgiques i Tractament Inicial
*   **`n_GC_Afect`**: Num√®rica. Nombre de ganglis sentinella afectats.
*   **`Reseccion_macroscopica_complet`**: Bin√†ria (0/1). Si s'ha extret tot el tumor visible (`1` √©s l'ideal).
*   **`Tratamiento_RT`** / **`Tratamiento_sistemico`**: Bin√†ries. Si va rebre Radioter√†pia o Quimio adjuvant.

---

## 3. Variables a ELIMINAR (Data Leakage / Soroll) üõë

Aquestes variables contenen informaci√≥ del "futur" (ocorren quan ja sabem que ha recaigut) o s√≥n identificadors irrellevants. **No les usis en l'entrenament.**

### Data Leakage (Spoilers del futur)
*   `recidiva_exitus`: √âs un proxy del target.
*   `diferencia_dias_reci_exit`: Revela quant temps va viure/va estar sana.
*   `fecha_de_recidi`: Si t√© data, √©s que va recaure.
*   `f_muerte`: Revela si va morir.
*   `causa_muerte`: Revela el resultat.
*   `tto_recidiva`: Tractament rebut *per* la recaiguda.
*   `Tt_recidiva_qx`: Cirurgia *per* la recaiguda.
*   `loc_recidiva_r01` a `r06`: Lloc de la recaiguda.
*   `numero_de_recid`, `num_recidiva`: Quantitat de recaigudes.
*   `libre_enferm`: Estat actual (similar al target).
*   `est_pcte`: Estat actual (viva/morta).
*   `visita_control`, `Ultima_fecha`: Dates de seguiment.

### Soroll / Identificadors
*   `codigo_participante`: ID aleatori.
*   `usuario_reg1`: ID administratiu.
*   Dates crues (`f_diag`, `FN`, `fecha_qx`): Usar `edad` en el seu lloc.
*   `comentarios`, `otras_especifi`: Text lliure no estructurat (dif√≠cil de processar amb poques dades).
*   `compl_precoc_rXX` (Complicacions): Generalment no prediuen la biologia del c√†ncer, nom√©s el postoperatori immediat.

---

## 4. Instruccions de Preprocessat ‚öôÔ∏è

1.  **Filtratge de files:** Elimina files on `recidiva` sigui `NA` o `2` (Desconegut).
2.  **Imputaci√≥ de Nuls (`NA`):**
    *   Per `recep_est_porcent`: Si falta, √©s cr√≠tic. Intentar imputar amb la mitjana o marcar com a "Desconegut".
    *   Per `Grado` o `FIGO`: Imputar amb la moda (valor m√©s freq√ºent).
3.  **Codificaci√≥:**
    *   Variables bin√†ries (S√≠/No) -> 1/0.
    *   `FIGO2023`: Mapejar manualment a ordre num√®ric (IA1 < IA2 < IB ...).
4.  **Estrat√®gia NSMP:**
    *   Idealment, el model hauria d'aprendre que si `p53_ihq` √©s Normal i `mut_pole` √©s No Mutat, la variable `recep_est_porcent` guanya molt de pes predictiu.

