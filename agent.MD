# Instruccions per a l'Agent d'IA - Projecte NEST

## Resum del Projecte
**Nom:** NEST (NSMP Endometrial Stratification Tool)
**Objectiu:** Predir la **probabilitat de recaiguda** en pacients amb C√†ncer d'Endometri NSMP.
**Usuaris finals:** Onc√≤legs Ginecol√≤gics.

## Producte Final
Aplicaci√≥ Streamlit amb:
1. **Login** - Autenticaci√≥ del doctor
2. **Formulari** - Entrada de dades del pacient
3. **Resultat** amb 3 panells:
   - Predicci√≥ (probabilitat + sem√†for üü¢üü°üî¥)
   - Interpretabilitat (gr√†fic d'import√†ncia de features, t√®cniques com SHAP)
   - Explicaci√≥ IA (Gemini API)

## Coneixement M√®dic Cr√≠tic
- **NSMP** = 50% dels casos, grup "calaix de sastre"
- **Prioritzem Sensibilitat (Recall)** - Un Fals Negatiu √©s fatal
- Divisi√≥ en: Baix, Mitj√† i Alt Risc

## Stack T√®cnic
- Python 3.11 / Streamlit / Scikit-learn / Pandas / Joblib
- Google Gemini API (explicacions)
- Docker & Docker Compose

## Estructura de Fitxers
```
‚îú‚îÄ‚îÄ data/raw/           # Dades originals
‚îú‚îÄ‚îÄ data/processed/     # Dades netes
‚îú‚îÄ‚îÄ notebooks/          # 01‚Üí02‚Üí03‚Üí04 en ordre
‚îú‚îÄ‚îÄ models/             # Models entrenats (.joblib)
‚îú‚îÄ‚îÄ app/                # Streamlit app
‚îî‚îÄ‚îÄ src/                # M√≤duls reutilitzables
```

---

## Regles Obligat√≤ries per a l'IA

### 1. Notebooks (.ipynb)
**MAI editis un fitxer `.ipynb` directament.**
Nom√©s proporciona el codi perqu√® l'usuari el copi√Ø.

### 2. Comentaris
- **Minimitza els comentaris** - Nom√©s quan sigui estrictament necessari
- **Tots els comentaris en CATAL√Ä**
- Exemple:
```python
# Carreguem el model entrenat
model = joblib.load('models/model.joblib')

# Fem la predicci√≥
prob = model.predict_proba(X)[0][1]
```

### 3. Idioma del Codi
| Element | Idioma |
|---------|--------|
| Variables i funcions | Angl√®s |
| Comentaris | Catal√† |
| UI Strings | Castell√†/Catal√† |

### 4. Convencions de Naming

#### Variables
```python
# ‚úÖ Correcte: snake_case, descriptiu, angl√®s
patient_age = 65
tumor_grade = 3
myometrial_invasion = 0.6
has_lvsi = True
recurrence_probability = 0.78

# ‚ùå Incorrecte
edad = 65           # Castell√†
tg = 3              # Massa curt
myometrialInvasion  # camelCase
```

#### Funcions
```python
# ‚úÖ Correcte: snake_case, verb + noun
def load_patient_data(filepath):
    pass

def calculate_recurrence_risk(features):
    pass

def preprocess_clinical_features(df):
    pass

# ‚ùå Incorrecte
def calcularRiesgo():    # Castell√† + camelCase
def data():              # Massa gen√®ric
def process():           # Qu√® processa?
```

#### Classes
```python
# ‚úÖ Correcte: PascalCase
class PatientData:
    pass

class RecurrencePredictor:
    pass

class FeatureEncoder:
    pass
```

#### Constants
```python
# ‚úÖ Correcte: SCREAMING_SNAKE_CASE
TARGET_COLUMN = 'recurrence'
RISK_THRESHOLDS = {'low': 0.3, 'medium': 0.6, 'high': 0.8}
MODEL_PATH = 'models/model.joblib'
GEMINI_MODEL = 'gemini-pro'
```

#### Fitxers
| Tipus | Format | Exemple |
|-------|--------|---------|
| Notebooks | `##_descriptive_name.ipynb` | `03_model_training.ipynb` |
| M√≤duls Python | `snake_case.py` | `feature_engineering.py` |
| Models | `model_name.joblib` | `random_forest_v2.joblib` |
| Dades | `descriptive_name.csv` | `features_train.csv` |

#### Prefixos i Sufixos Est√†ndard
| Prefix/Sufix | Significat | Exemple |
|--------------|------------|---------|
| `X_`, `y_` | Features / Target | `X_train`, `y_test` |
| `_df` | DataFrame | `patients_df` |
| `_path` | Ruta de fitxer | `model_path` |
| `_config` | Configuraci√≥ | `app_config` |
| `is_`, `has_` | Booleans | `is_valid`, `has_lvsi` |
| `n_`, `num_` | Comptadors | `n_samples`, `num_features` |
| `_scaled` | Dades normalitzades | `X_scaled` |
| `_encoded` | Dades codificades | `stage_encoded` |

#### Convencions de Versionat

Quan es fan m√∫ltiples experiments (preprocessats, models, etc.), segueix aquest format:

**Format:** `nom_descriptiu_vX.extensi√≥`

| Tipus | Exemple | Descripci√≥ |
|-------|---------|------------|
| **Models** | `random_forest_v1.joblib` | Versi√≥ 1 del RF |
|  | `xgboost_smote_v2.joblib` | XGBoost amb SMOTE, versi√≥ 2 |
| **Scalers** | `scaler_v1.joblib` | Scaler per a v1 del model |
|  | `scaler_minmax_v2.joblib` | MinMaxScaler per a v2 |
| **Dades processades** | `features_train_v1.csv` | Train set versi√≥ 1 |
|  | `features_train_smote_v2.csv` | Amb SMOTE aplicat |
| **Encoders** | `label_encoder_v1.joblib` | Encoder per a categoricals |

**Regles:**
- Sempre incrementa la versi√≥ quan canvi√Øs el preprocessat o els hiperpar√†metres
- Inclou t√®cnica en el nom si √©s rellevant (`_smote`, `_minmax`, `_pca`)
- El model i el scaler han de coincidir en versi√≥ (`model_v2` + `scaler_v2`)
- MAI sobreescriguis versions anteriors, crea una nova

**Estructura de directoris recomanada:**
```
models/
‚îú‚îÄ‚îÄ model_v1.joblib           # Baseline
‚îú‚îÄ‚îÄ model_v2.joblib           # Amb tuning
‚îú‚îÄ‚îÄ model_smote_v3.joblib     # Amb SMOTE
‚îú‚îÄ‚îÄ scaler_v1.joblib
‚îú‚îÄ‚îÄ scaler_v2.joblib
‚îî‚îÄ‚îÄ scaler_v3.joblib

data/processed/
‚îú‚îÄ‚îÄ features_train_v1.csv
‚îú‚îÄ‚îÄ features_test_v1.csv
‚îú‚îÄ‚îÄ features_train_v2.csv     # Nou preprocessat
‚îî‚îÄ‚îÄ features_test_v2.csv
```

### 5. Estil de Codi
- Segueix PEP 8
- Codi net i llegible
- M√†xim 88 car√†cters per l√≠nia
- Evita codi redundant

### 6. Convencions de Fitxers

#### Imports (ordre)
```python
# 1. Standard library
import os
from pathlib import Path

# 2. Third-party
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestClassifier

# 3. Local
from src.preprocessing import clean_data
```

#### Estructura d'un m√≤dul
```python
"""
Descripci√≥ breu del m√≤dul (en angl√®s).
"""
# Imports
import pandas as pd

# Constants
TARGET_COLUMN = 'recurrence'

# Funcions auxiliars (privades amb _)
def _validate_input(df):
    pass

# Funcions p√∫bliques
def load_data(path):
    pass

# Classes
class DataProcessor:
    pass
```

### 7. Vocabulari del Domini (Terminologia M√®dica)

Utilitza sempre aquests termes en angl√®s per consist√®ncia:

| Catal√†/Castell√† | Angl√®s (usar sempre) |
|-----------------|---------------------|
| Recaiguda/Reca√≠da | `recurrence` |
| Grau tumoral | `tumor_grade` |
| Invasi√≥ miometrial | `myometrial_invasion` |
| Estadi | `stage` |
| LVSI | `lvsi` (ja √©s acr√≤nim angl√®s) |
| Pacient | `patient` |
| Predicci√≥ | `prediction` |
| Probabilitat | `probability` |
| Risc | `risk` |
| Alt/Mitj√†/Baix | `high`, `medium`, `low` |

---

## Informaci√≥ T√®cnica del Projecte

### Workflow de Notebooks (Executar en ORDRE)

```
01_exploratory_analysis.ipynb  ‚Üí No guarda res
02_data_preprocessing.ipynb    ‚Üí GUARDA: data/processed/*.csv, models/scaler.joblib
03_model_training.ipynb        ‚Üí CARGA des de data/processed/, GUARDA: models/model.joblib
04_model_evaluation.ipynb      ‚Üí CARGA: models/model.joblib, features_test.csv
app/main.py (Streamlit)        ‚Üí CARGA: models/model.joblib, models/scaler.joblib
```

### Joblib (Persist√®ncia de Models)

Guardar model/scaler:
```python
import joblib
joblib.dump(model, '../models/model.joblib')
joblib.dump(scaler, '../models/scaler.joblib')
```

Carregar en app o notebook posterior:
```python
model = joblib.load('models/model.joblib')
scaler = joblib.load('models/scaler.joblib')
```

### Entorns d'Execuci√≥

| Entorn | √ös | Comanda |
|--------|-----|---------|
| **Docker** | App Streamlit | `docker compose up --build -d` |
| **venv local** | Notebooks | `.venv\Scripts\activate` |

### Paths Importants (des de notebooks/)
- Dades: `../data/processed/`
- Models: `../models/`
- Scaler: `../models/scaler.joblib`

### Paths Importants (des de app/)
- Models: `models/` (sense `../` perqu√® Docker munta a /app)
